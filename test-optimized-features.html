<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemSafe Pro ä¼˜åŒ–ç‰ˆåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            padding: 20px;
            background: #f5f7fa;
            line-height: 1.6;
        }
        .test-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 12px 0;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
        pre {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status-pass { background: #d4edda; color: #155724; }
        .status-fail { background: #f8d7da; color: #721c24; }
        .feature-list { list-style: none; padding: 0; }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ChemSafe Pro ä¼˜åŒ–ç‰ˆåŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•</h1>

    <div class="test-container">
        <h2>1. åº”ç”¨ç¨‹åºåˆå§‹åŒ–æµ‹è¯•</h2>
        <div id="init-test"></div>
    </div>

    <div class="test-container">
        <h2>2. æœåŠ¡æ¨¡å—åŠ è½½æµ‹è¯•</h2>
        <ul class="feature-list">
            <li>
                åŒ–å­¦æ•°æ®æœåŠ¡ (ChemicalDataService)
                <span id="chemical-data-status" class="status-badge">æµ‹è¯•ä¸­...</span>
            </li>
            <li>
                æœ¬åœ°æ•°æ®æœåŠ¡ (LocalDataService)
                <span id="local-data-status" class="status-badge">æµ‹è¯•ä¸­...</span>
            </li>
            <li>
                é‡å¤§å±é™©æºè¯„ä¼° (MajorHazardAssessment)
                <span id="hazard-assessment-status" class="status-badge">æµ‹è¯•ä¸­...</span>
            </li>
            <li>
                GHSåˆ†ç±»ç³»ç»Ÿ (GHSClassificationSystem)
                <span id="ghs-status" class="status-badge">æµ‹è¯•ä¸­...</span>
            </li>
        </ul>
    </div>

    <div class="test-container">
        <h2>3. å“åº”å¼å¸ƒå±€æµ‹è¯•</h2>
        <div id="responsive-test"></div>
    </div>

    <div class="test-container">
        <h2>4. å…³é”®åŠŸèƒ½æµ‹è¯•</h2>
        <div id="function-test"></div>
    </div>

    <div class="test-container">
        <h2>5. é‡å¤§å±é™©æºè¯„ä¼°éªŒè¯</h2>
        <div id="hazard-verification"></div>
    </div>

    <script type="module">
        // æµ‹è¯•åº”ç”¨åˆå§‹åŒ–
        async function testAppInitialization() {
            try {
                // åŠ¨æ€å¯¼å…¥ä¼˜åŒ–çš„åº”ç”¨
                const { ChemSafeProApp } = await import('./src/js/optimized-app.js');

                // åˆ›å»ºåº”ç”¨å®ä¾‹è¿›è¡Œæµ‹è¯•ï¼ˆä¸æ˜¾ç¤ºUIï¼‰
                const testApp = new (class extends ChemSafeProApp {
                    constructor() {
                        super();
                        // è¦†ç›–UIåˆå§‹åŒ–ä»¥é¿å…DOMæ“ä½œé”™è¯¯
                        this.ui = {
                            loadingIndicator: { style: { display: 'none' } },
                            app: { style: { display: 'block' } },
                            searchInput: { focus: () => {} },
                            searchBtn: {
                                classList: { add: () => {}, remove: () => {} },
                                disabled: false
                            },
                            stats: {
                                searchCount: { textContent: '' },
                                localDbCount: { textContent: '' }
                            }
                        };
                    }

                    initializeUI() {
                        return this.ui;
                    }

                    showLoading() {}
                    hideLoading() {}
                })();

                document.getElementById('init-test').innerHTML = `
                    <div class="test-result success">
                        <strong>âœ… åº”ç”¨åˆå§‹åŒ–æˆåŠŸ</strong><br>
                        æœåŠ¡æ•°é‡: ${Object.keys(testApp.services).length}<br>
                        çŠ¶æ€åˆå§‹åŒ–: ${testApp.state ? 'æˆåŠŸ' : 'å¤±è´¥'}
                    </div>
                `;

                return testApp;
            } catch (error) {
                document.getElementById('init-test').innerHTML = `
                    <div class="test-result error">
                        <strong>âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
                throw error;
            }
        }

        // æµ‹è¯•æœåŠ¡æ¨¡å—
        async function testServices() {
            try {
                const { ChemicalDataService } = await import('./src/services/chemical-data-service.js');
                const { LocalDataService } = await import('./src/services/local-data-service.js');
                const { MajorHazardAssessment } = await import('./src/services/major-hazard-assessment.js');
                const { GHSClassificationSystem } = await import('./src/services/ghs-classification.js');

                // æµ‹è¯•åŒ–å­¦æ•°æ®æœåŠ¡
                const chemicalService = new ChemicalDataService();
                document.getElementById('chemical-data-status').textContent = 'é€šè¿‡';
                document.getElementById('chemical-data-status').className = 'status-badge status-pass';

                // æµ‹è¯•æœ¬åœ°æ•°æ®æœåŠ¡
                const localService = new LocalDataService();
                const totalCount = localService.getTotalCount();
                document.getElementById('local-data-status').textContent = `é€šè¿‡ (${totalCount}æ¡æ•°æ®)`;
                document.getElementById('local-data-status').className = 'status-badge status-pass';

                // æµ‹è¯•é‡å¤§å±é™©æºè¯„ä¼°
                const hazardService = new MajorHazardAssessment();
                const testResult = hazardService.identifySingleSubstance('7664-41-7', 15, 't');
                document.getElementById('hazard-assessment-status').textContent = `é€šè¿‡ (${testResult.level.name})`;
                document.getElementById('hazard-assessment-status').className = 'status-badge status-pass';

                // æµ‹è¯•GHSåˆ†ç±»ç³»ç»Ÿ
                const ghsService = new GHSClassificationSystem();
                document.getElementById('ghs-status').textContent = 'é€šè¿‡';
                document.getElementById('ghs-status').className = 'status-badge status-pass';

                return { chemicalService, localService, hazardService, ghsService };
            } catch (error) {
                const failedServices = ['chemical-data-status', 'local-data-status', 'hazard-assessment-status', 'ghs-status'];
                failedServices.forEach(id => {
                    const element = document.getElementById(id);
                    if (element.textContent === 'æµ‹è¯•ä¸­...') {
                        element.textContent = 'å¤±è´¥';
                        element.className = 'status-badge status-fail';
                    }
                });
                throw error;
            }
        }

        // æµ‹è¯•å“åº”å¼å¸ƒå±€
        function testResponsiveLayout() {
            const breakpoints = [
                { name: 'æ¡Œé¢ç‰ˆ', width: 1200 },
                { name: 'å¹³æ¿ç‰ˆ', width: 768 },
                { name: 'æ‰‹æœºç‰ˆ', width: 480 },
                { name: 'å°å±æ‰‹æœº', width: 320 }
            ];

            let results = breakpoints.map(bp => {
                // æ¨¡æ‹Ÿä¸åŒå±å¹•å°ºå¯¸
                const isSupported = window.matchMedia ?
                    window.matchMedia(`(max-width: ${bp.width}px)`).matches ||
                    window.innerWidth <= bp.width : true;

                return `
                    <div class="test-result ${isSupported ? 'success' : 'info'}">
                        ${bp.name} (${bp.width}px): ${isSupported ? 'âœ… é€‚é…' : 'â„¹ï¸ å½“å‰ä¸åœ¨æ­¤æ–­ç‚¹'}
                    </div>
                `;
            }).join('');

            document.getElementById('responsive-test').innerHTML = results + `
                <div class="test-result info">
                    <strong>å½“å‰è§†çª—å°ºå¯¸:</strong> ${window.innerWidth}px Ã— ${window.innerHeight}px
                </div>
            `;
        }

        // æµ‹è¯•å…³é”®åŠŸèƒ½
        async function testKeyFunctions(services) {
            try {
                const tests = [];

                // æµ‹è¯•æœ¬åœ°æœç´¢
                const localResult = services.localService.searchByName('æ°¨');
                tests.push({
                    name: 'æœ¬åœ°æœç´¢åŠŸèƒ½',
                    result: localResult ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥',
                    details: localResult ? `æ‰¾åˆ°: ${localResult.name} (${localResult.cas})` : 'æœªæ‰¾åˆ°ç»“æœ'
                });

                // æµ‹è¯•é‡å¤§å±é™©æºè¯„ä¼°
                const hazardResult = services.hazardService.identifySingleSubstance('7664-41-7', 10, 't');
                tests.push({
                    name: 'é‡å¤§å±é™©æºè¯„ä¼°',
                    result: hazardResult.level ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥',
                    details: hazardResult.level ?
                        `ç­‰çº§: ${hazardResult.level.name}, Rå€¼: ${hazardResult.riskQuotient}` :
                        'è¯„ä¼°å¤±è´¥'
                });

                // æµ‹è¯•å¤šç‰©è´¨è¯„ä¼°
                const multiResult = services.hazardService.identifyMultipleSubstances([
                    { cas: '7664-41-7', quantity: 5, unit: 't' },
                    { cas: '7782-50-5', quantity: 2, unit: 't' }
                ]);
                tests.push({
                    name: 'å¤šä»‹è´¨å±é™©æºè¯„ä¼°',
                    result: multiResult.level ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥',
                    details: multiResult.level ?
                        `æ€»Rå€¼: ${multiResult.totalRiskQuotient.toFixed(3)}, ç­‰çº§: ${multiResult.level.name}` :
                        'è¯„ä¼°å¤±è´¥'
                });

                const resultsHtml = tests.map(test => `
                    <div class="test-result ${test.result.includes('âœ…') ? 'success' : 'error'}">
                        <strong>${test.name}:</strong> ${test.result}<br>
                        <small>${test.details}</small>
                    </div>
                `).join('');

                document.getElementById('function-test').innerHTML = resultsHtml;
            } catch (error) {
                document.getElementById('function-test').innerHTML = `
                    <div class="test-result error">
                        <strong>âŒ åŠŸèƒ½æµ‹è¯•å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // æ‰§è¡Œé‡å¤§å±é™©æºéªŒè¯
        function testHazardVerification(services) {
            try {
                const verificationTests = [
                    {
                        name: 'æ°¨æ°”æ ‡å‡†éªŒè¯',
                        cas: '7664-41-7',
                        quantity: 15,
                        expectedLevel: 'å››çº§é‡å¤§å±é™©æº',
                        expectedR: 1.5
                    },
                    {
                        name: 'æ°¯æ°”æ ‡å‡†éªŒè¯',
                        cas: '7782-50-5',
                        quantity: 10,
                        expectedLevel: 'å››çº§é‡å¤§å±é™©æº',
                        expectedR: 2.0
                    }
                ];

                const results = verificationTests.map(test => {
                    try {
                        const result = services.hazardService.identifySingleSubstance(test.cas, test.quantity, 't');
                        const rMatch = Math.abs(result.riskQuotient - test.expectedR) < 0.1;
                        const levelMatch = result.level.name === test.expectedLevel;

                        return `
                            <div class="test-result ${rMatch && levelMatch ? 'success' : 'warning'}">
                                <strong>${test.name}:</strong><br>
                                é£é™©å•†: ${result.riskQuotient} (é¢„æœŸ: ${test.expectedR}) ${rMatch ? 'âœ…' : 'âš ï¸'}<br>
                                ç­‰çº§: ${result.level.name} (é¢„æœŸ: ${test.expectedLevel}) ${levelMatch ? 'âœ…' : 'âš ï¸'}
                            </div>
                        `;
                    } catch (error) {
                        return `
                            <div class="test-result error">
                                <strong>${test.name}:</strong> âŒ æµ‹è¯•å¤±è´¥ - ${error.message}
                            </div>
                        `;
                    }
                }).join('');

                document.getElementById('hazard-verification').innerHTML = results;
            } catch (error) {
                document.getElementById('hazard-verification').innerHTML = `
                    <div class="test-result error">
                        <strong>âŒ éªŒè¯æµ‹è¯•å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            try {
                console.log('å¼€å§‹æ‰§è¡ŒåŠŸèƒ½æµ‹è¯•...');

                // 1. åˆå§‹åŒ–æµ‹è¯•
                const app = await testAppInitialization();

                // 2. æœåŠ¡æµ‹è¯•
                const services = await testServices();

                // 3. å“åº”å¼æµ‹è¯•
                testResponsiveLayout();

                // 4. åŠŸèƒ½æµ‹è¯•
                await testKeyFunctions(services);

                // 5. éªŒè¯æµ‹è¯•
                testHazardVerification(services);

                console.log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');

            } catch (error) {
                console.error('æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>