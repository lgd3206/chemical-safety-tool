<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GB18218-2018é‡å¤§å±é™©æºè¯„ä¼°éªŒè¯æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        h2 { color: #333; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .correction-factors { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” GB18218-2018é‡å¤§å±é™©æºè¯„ä¼°æ ‡å‡†éªŒè¯æµ‹è¯•</h1>

    <div class="test-container">
        <h2>æµ‹è¯• 1: æ°¨æ°”æ ‡å‡†éªŒè¯</h2>
        <p>æµ‹è¯•ç”¨ä¾‹ï¼šæ°¨æ°” (CAS: 7664-41-7) å­˜å‚¨é‡ 15 å¨</p>
        <p>GB18218-2018æ ‡å‡†ï¼šä¸´ç•Œé‡ 10tï¼Œæ ¡æ­£ç³»æ•°Î²=2</p>
        <p>é¢„æœŸç»“æœï¼šé£é™©å•† R = (15/10) Ã— 2 = 3.0ï¼Œåº”ä¸ºå››çº§é‡å¤§å±é™©æº</p>
        <div id="test1-result"></div>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯• 2: æ°¯æ°”æ ‡å‡†éªŒè¯</h2>
        <p>æµ‹è¯•ç”¨ä¾‹ï¼šæ°¯æ°” (CAS: 7782-50-5) å­˜å‚¨é‡ 10 å¨</p>
        <p>GB18218-2018æ ‡å‡†ï¼šä¸´ç•Œé‡ 5tï¼Œæ ¡æ­£ç³»æ•°Î²=4</p>
        <p>é¢„æœŸç»“æœï¼šé£é™©å•† R = (10/5) Ã— 4 = 8.0ï¼Œåº”ä¸ºå››çº§é‡å¤§å±é™©æº</p>
        <div id="test2-result"></div>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯• 3: è‹¯æ ‡å‡†éªŒè¯</h2>
        <p>æµ‹è¯•ç”¨ä¾‹ï¼šè‹¯ (CAS: 71-43-2) å­˜å‚¨é‡ 100 å¨</p>
        <p>GB18218-2018æ ‡å‡†ï¼šä¸´ç•Œé‡ 50tï¼Œæ ¡æ­£ç³»æ•°Î²=1ï¼ˆæ˜“ç‡ƒæ¶²ä½“é»˜è®¤ï¼‰</p>
        <p>é¢„æœŸç»“æœï¼šé£é™©å•† R = (100/50) Ã— 1 = 2.0ï¼Œåº”ä¸ºå››çº§é‡å¤§å±é™©æº</p>
        <div id="test3-result"></div>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯• 4: å¤šä»‹è´¨è¯„ä¼°ï¼ˆå«äººå‘˜æ ¡æ­£ï¼‰</h2>
        <p>æµ‹è¯•ç”¨ä¾‹ï¼šæ°¨æ°” 20å¨ + æ°¯æ°” 3å¨ï¼Œæš´éœ²äººå‘˜ 80äºº</p>
        <p>è®¡ç®—ï¼š(20/10)Ã—2 + (3/5)Ã—4 = 4 + 2.4 = 6.4</p>
        <p>äººå‘˜æ ¡æ­£ï¼š6.4 Ã— 1.5 = 9.6ï¼ˆ50-99äººæ ¡æ­£ç³»æ•°Î±=1.5ï¼‰</p>
        <p>é¢„æœŸç»“æœï¼šæœ€ç»ˆR = 9.6ï¼Œåº”ä¸ºå››çº§é‡å¤§å±é™©æº</p>
        <div id="test4-result"></div>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯• 5: åˆ†çº§æ ‡å‡†éªŒè¯</h2>
        <p>æµ‹è¯•ä¸åŒRå€¼çš„åˆ†çº§æƒ…å†µ</p>
        <div id="test5-result"></div>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯• 6: ä¸´ç•Œé‡æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</h2>
        <p>æ£€æŸ¥å…³é”®å±é™©åŒ–å­¦å“çš„ä¸´ç•Œé‡æ•°æ®</p>
        <div id="test6-result"></div>
    </div>

    <script type="module">
        import { MajorHazardAssessment } from './src/services/major-hazard-assessment.js';

        const assessment = new MajorHazardAssessment();

        function runTest(testId, testFunction, description) {
            const resultDiv = document.getElementById(testId);
            try {
                const result = testFunction();
                resultDiv.innerHTML = `
                    <div class="test-result success">
                        <strong>âœ… æµ‹è¯•é€šè¿‡</strong><br>
                        ${description}<br>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        <strong>âŒ æµ‹è¯•å¤±è´¥</strong><br>
                        é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        // æµ‹è¯• 1: æ°¨æ°”æ ‡å‡†éªŒè¯
        runTest('test1-result', () => {
            const result = assessment.identifySingleSubstance('7664-41-7', 15, 't');
            console.log('Test 1 - æ°¨æ°” 15å¨:', result);

            // åŸºæœ¬éªŒè¯
            if (Math.abs(result.riskQuotient - 1.5) > 0.001) {
                throw new Error(`åŸºç¡€é£é™©å•†è®¡ç®—é”™è¯¯: æœŸæœ› 1.5, å®é™… ${result.riskQuotient}`);
            }

            // éªŒè¯æ ¡æ­£ç³»æ•°è®¡ç®—
            const correctionFactor = assessment.getCorrectionFactor('7664-41-7', 'toxicGas');
            const adjustedRisk = result.riskQuotient * correctionFactor;

            return {
                substance: result.substance.name,
                basicRiskQuotient: result.riskQuotient,
                correctionFactor: correctionFactor,
                adjustedRiskQuotient: adjustedRisk,
                level: result.level.name,
                standard: 'GB18218-2018è¡¨1+è¡¨3'
            };
        }, 'æ°¨æ°”æ ‡å‡†éªŒè¯ - ä¸´ç•Œé‡10tï¼Œæ ¡æ­£ç³»æ•°Î²=2');

        // æµ‹è¯• 2: æ°¯æ°”æ ‡å‡†éªŒè¯
        runTest('test2-result', () => {
            const result = assessment.identifySingleSubstance('7782-50-5', 10, 't');
            console.log('Test 2 - æ°¯æ°” 10å¨:', result);

            const correctionFactor = assessment.getCorrectionFactor('7782-50-5', 'toxicGas');
            const adjustedRisk = result.riskQuotient * correctionFactor;

            return {
                substance: result.substance.name,
                basicRiskQuotient: result.riskQuotient,
                correctionFactor: correctionFactor,
                adjustedRiskQuotient: adjustedRisk,
                level: result.level.name,
                standard: 'GB18218-2018è¡¨1+è¡¨3'
            };
        }, 'æ°¯æ°”æ ‡å‡†éªŒè¯ - ä¸´ç•Œé‡5tï¼Œæ ¡æ­£ç³»æ•°Î²=4');

        // æµ‹è¯• 3: è‹¯æ ‡å‡†éªŒè¯
        runTest('test3-result', () => {
            const result = assessment.identifySingleSubstance('71-43-2', 100, 't');
            console.log('Test 3 - è‹¯ 100å¨:', result);

            const correctionFactor = assessment.getCorrectionFactor('71-43-2', 'flammableLiquid');

            return {
                substance: result.substance.name,
                basicRiskQuotient: result.riskQuotient,
                correctionFactor: correctionFactor,
                level: result.level.name,
                standard: 'GB18218-2018è¡¨1+è¡¨4'
            };
        }, 'è‹¯æ ‡å‡†éªŒè¯ - ä¸´ç•Œé‡50tï¼Œæ˜“ç‡ƒæ¶²ä½“é»˜è®¤Î²=1');

        // æµ‹è¯• 4: å¤šä»‹è´¨è¯„ä¼°ï¼ˆå«äººå‘˜æ ¡æ­£ï¼‰
        runTest('test4-result', () => {
            const substances = [
                { cas: '7664-41-7', quantity: 20, unit: 't' },    // æ°¨æ°” 20å¨
                { cas: '7782-50-5', quantity: 3, unit: 't' }     // æ°¯æ°” 3å¨
            ];

            // ä½¿ç”¨æ”¯æŒäººå‘˜æ ¡æ­£çš„é«˜çº§è¯„ä¼°æ–¹æ³•
            let result;
            if (typeof assessment.identifyMultipleSubstancesAdvanced === 'function') {
                result = assessment.identifyMultipleSubstancesAdvanced(substances, 80);
            } else {
                // å¦‚æœæ²¡æœ‰é«˜çº§æ–¹æ³•ï¼Œä½¿ç”¨æ ‡å‡†æ–¹æ³•
                result = assessment.identifyMultipleSubstances(substances);
            }

            console.log('Test 4 - å¤šä»‹è´¨è¯„ä¼°:', result);

            // æ ¹æ®å®é™…è¿”å›çš„ç»“æ„è°ƒæ•´æµ‹è¯•
            const baseRisk = result.baseRiskQuotient || result.totalRiskQuotient;
            const finalRisk = result.finalRiskQuotient || result.totalRiskQuotient;

            return {
                baseRiskQuotient: baseRisk,
                personnelCorrectionFactor: result.personnelCorrectionFactor || 1,
                finalRiskQuotient: finalRisk,
                level: result.level.name,
                exposedPersonnel: result.exposedPersonnel || 0,
                substances: result.substances.map(s => ({
                    name: s.name,
                    baseRisk: s.baseRiskQuotient || s.riskQuotient,
                    correctionFactor: s.correctionFactor || 1,
                    adjustedRisk: s.adjustedRiskQuotient || s.riskQuotient,
                    contribution: s.contribution + '%'
                }))
            };
        }, 'å¤šä»‹è´¨+äººå‘˜æ ¡æ­£è¯„ä¼°');

        // æµ‹è¯• 5: åˆ†çº§æ ‡å‡†éªŒè¯
        runTest('test5-result', () => {
            const testCases = [
                { r: 150, expected: 'ä¸€çº§é‡å¤§å±é™©æº' },
                { r: 80, expected: 'äºŒçº§é‡å¤§å±é™©æº' },
                { r: 30, expected: 'ä¸‰çº§é‡å¤§å±é™©æº' },
                { r: 5, expected: 'å››çº§é‡å¤§å±é™©æº' },
                { r: 0.5, expected: 'éé‡å¤§å±é™©æº' }
            ];

            const results = testCases.map(test => {
                const level = assessment.determineHazardLevel(test.r);
                const passed = level.name === test.expected;
                return {
                    rValue: test.r,
                    expected: test.expected,
                    actual: level.name,
                    range: level.range,
                    passed: passed
                };
            });

            const allPassed = results.every(r => r.passed);
            if (!allPassed) {
                throw new Error('åˆ†çº§æ ‡å‡†éªŒè¯å¤±è´¥');
            }

            return { results, allPassed };
        }, 'åˆ†çº§æ ‡å‡†éªŒè¯');

        // æµ‹è¯• 6: ä¸´ç•Œé‡æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        runTest('test6-result', () => {
            const keyCAS = [
                '7664-41-7', // æ°¨
                '7782-50-5', // æ°¯æ°”
                '71-43-2',   // è‹¯
                '67-56-1',   // ç”²é†‡
                '74-82-8',   // ç”²çƒ·
                '1333-74-0', // æ°¢æ°”
                '7697-37-2', // ç¡é…¸
                '118-96-7'   // TNT
            ];

            const dataCheck = keyCAS.map(cas => {
                const substance = assessment.findSubstanceByCAS(cas);
                return {
                    cas: cas,
                    found: !!substance,
                    name: substance?.name || 'NOT FOUND',
                    criticalQuantity: substance?.criticalQuantity || 'N/A',
                    category: substance?.category || 'N/A'
                };
            });

            const totalCount = Object.keys(assessment.criticalQuantities).length;

            return {
                totalSubstances: totalCount,
                keySubstancesCheck: dataCheck,
                allKeyFound: dataCheck.every(d => d.found)
            };
        }, 'ä¸´ç•Œé‡æ•°æ®å®Œæ•´æ€§æ£€æŸ¥');

        // æ˜¾ç¤ºæ ¡æ­£ç³»æ•°è¡¨
        document.body.innerHTML += `
            <div class="test-container">
                <h2>æ ¡æ­£ç³»æ•°Î²å‚è€ƒè¡¨</h2>
                <div class="correction-factors">
                    <h4>æ¯’æ€§æ°”ä½“æ ¡æ­£ç³»æ•°ï¼ˆGB18218-2018è¡¨3ï¼‰</h4>
                    <p>æ°¨(Î²=2), æ°¯æ°”(Î²=4), ç¡«åŒ–æ°¢(Î²=3), ä¸€æ°§åŒ–ç¢³(Î²=10), æ°Ÿ(Î²=10)ç­‰</p>

                    <h4>äººå‘˜æš´éœ²æ ¡æ­£ç³»æ•°Î±ï¼ˆGB18218-2018è¡¨5ï¼‰</h4>
                    <p>100äººä»¥ä¸Š(Î±=2.0), 50-99äºº(Î±=1.5), 30-49äºº(Î±=1.2), 1-29äºº(Î±=1.0), 0äºº(Î±=0.5)</p>

                    <h4>é‡å¤§å±é™©æºåˆ†çº§æ ‡å‡†ï¼ˆGB18218-2018è¡¨6ï¼‰</h4>
                    <p>ä¸€çº§: Râ‰¥100, äºŒçº§: 100>Râ‰¥50, ä¸‰çº§: 50>Râ‰¥10, å››çº§: 10>Râ‰¥1, éé‡å¤§å±é™©æº: R<1</p>
                </div>
            </div>
        ` + document.body.innerHTML;
    </script>
</body>
</html>